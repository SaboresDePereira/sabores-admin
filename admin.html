<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel ¬∑ Sabores de Pereira</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f1f5f9;
    }

    header {
      background: linear-gradient(135deg, #111827, #1f2937);
      color: white;
      padding: 22px;
      text-align: center;
      font-size: 22px;
      font-weight: 900;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    input {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      margin-bottom: 20px;
      font-size: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
    }

    h2 {
      margin-top: 30px;
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .seccion {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
    }

    .pedido {
      background: white;
      padding: 14px;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,.1);
      cursor: pointer;
      transition: transform .15s;
    }

    .pedido:hover {
      transform: scale(1.02);
    }

    .pedido-header {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
    }

    .codigo {
      background: #111827;
      color: white;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 12px;
    }

    .fecha {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }

    .total {
      color: #16a34a;
      font-weight: 900;
      margin-top: 6px;
    }

    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 520px;
      border-radius: 20px;
      padding: 22px;
      max-height: 85%;
      overflow: auto;
    }

    .close {
      text-align: right;
      font-weight: 800;
      color: #ef4444;
      cursor: pointer;
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      margin-top: 16px;
      font-weight: 700;
    }

    footer {
      margin-top: 50px;
      background: #111827;
      color: #ddd;
      padding: 22px;
      text-align: center;
      font-size: 13px;
    }
  </style>
</head>

<body>

<header>üì¶ Panel de Pedidos ¬∑ Sabores de Pereira</header>

<div class="container">
  <input type="search" id="search" placeholder="üîç Buscar por nombre o c√≥digo">

  <h2>üÜï Nuevos</h2>
  <div id="nuevo" class="seccion"></div>

  <h2>‚úÖ Confirmados</h2>
  <div id="confirmado" class="seccion"></div>

  <h2>üç≥ Listos</h2>
  <div id="listo" class="seccion"></div>

  <h2>üöö Entregados</h2>
  <div id="entregado" class="seccion"></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="close" onclick="cerrarModal()">Cerrar ‚úñ</div>
    <div id="detalle"></div>
  </div>
</div>

<footer>
  <strong>SABORES DE PEREIRA</strong><br>
  Panel interno ¬∑ ¬© 2026
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCHYo8LYSyOqgr6tBgo9RXODH0KRwZeowQ",
    authDomain: "live-de-eso.firebaseapp.com",
    projectId: "live-de-eso",
    storageBucket: "live-de-eso.firebasestorage.app",
    messagingSenderId: "250545251960",
    appId: "1:250545251960:web:94ad354f2650d46d32af8d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // üîî Permiso notificaciones
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  const search = document.getElementById("search");
  const modal = document.getElementById("modal");
  const detalle = document.getElementById("detalle");

  const secciones = {
    nuevo: document.getElementById("nuevo"),
    confirmado: document.getElementById("confirmado"),
    listo: document.getElementById("listo"),
    entregado: document.getElementById("entregado")
  };

  let pedidos = [];
  let pedidosPrevios = [];

  const q = query(collection(db, "pedidos"), orderBy("fecha", "desc"));

  onSnapshot(q, snap => {
    const nuevos = [];
    pedidos = [];

    snap.forEach(d => {
      const p = { id: d.id, ...d.data() };
      pedidos.push(p);

      if (!pedidosPrevios.find(x => x.id === p.id)) {
        nuevos.push(p);
      }
    });

    nuevos.forEach(p => {
      if (p.estado === "nuevo") {
        notificar("üÜï Pedido nuevo", `${p.codigo} ¬∑ ${p.cliente.nombre}`);
      }
    });

    pedidosPrevios = pedidos.map(p => ({ id: p.id }));
    render();
  });

  function fechaChile(ts) {
    return ts.toDate().toLocaleString("es-CL", {
      timeZone: "America/Santiago",
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function render() {
    Object.values(secciones).forEach(s => s.innerHTML = "");
    const f = search.value.toLowerCase();

    pedidos.filter(p =>
      p.codigo.toLowerCase().includes(f) ||
      p.cliente.nombre.toLowerCase().includes(f)
    ).forEach(p => {
      const div = document.createElement("div");
      div.className = "pedido";
      div.innerHTML = `
        <div class="pedido-header">
          <div>${p.cliente.nombre}</div>
          <div class="codigo">${p.codigo}</div>
        </div>
        <div class="fecha">‚è∞ ${fechaChile(p.fecha)}</div>
        <div class="total">$${p.total}</div>
      `;
      div.onclick = () => verDetalle(p);
      secciones[p.estado]?.appendChild(div);
    });
  }

  search.oninput = render;

  function verDetalle(p) {
    detalle.innerHTML = `
      <h3>Pedido ${p.codigo}</h3>
      <p><b>Cliente:</b> ${p.cliente.nombre}</p>
      <p><b>Tel√©fono:</b> ${p.cliente.telefono}</p>
      <p><b>Enviado:</b> ${fechaChile(p.fecha)}</p>

      <h4>Productos</h4>
      <ul>
        ${p.items.map(i => `<li>${i.name} ${i.size ?? ""} - $${i.price}</li>`).join("")}
      </ul>

      <p><b>Total:</b> $${p.total}</p>

      <select onchange="cambiarEstado('${p.id}', this.value)">
        <option ${p.estado === "nuevo" ? "selected" : ""}>nuevo</option>
        <option ${p.estado === "confirmado" ? "selected" : ""}>confirmado</option>
        <option ${p.estado === "listo" ? "selected" : ""}>listo</option>
        <option ${p.estado === "entregado" ? "selected" : ""}>entregado</option>
      </select>
    `;
    modal.classList.add("active");
  }

  window.cerrarModal = () => modal.classList.remove("active");

  window.cambiarEstado = async (id, estado) => {
    await updateDoc(doc(db, "pedidos", id), { estado });
    cerrarModal();
  };

  function notificar(titulo, texto) {
    if (Notification.permission === "granted") {
      new Notification(titulo, {
        body: texto,
        icon: "https://cdn-icons-png.flaticon.com/512/3081/3081559.png"
      });
    }
  }
</script>

</body>
</html>
